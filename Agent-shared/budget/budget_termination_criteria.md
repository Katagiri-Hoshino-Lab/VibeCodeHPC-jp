# 予算基準によるプロジェクト終了条件

## 概要
プロジェクトの終了判断をPMの主観ではなく、スパコン予算（計算ポイント）の消費状況に基づいて客観的に行う。

## 基本原則
- **主観的判断の排除**: PMの「そろそろ終わりにしよう」という主観的判断を完全に排除
- **透明性の確保**: 全エージェントが終了条件と現在のフェーズを把握可能
- **段階的対応**: 予算消費率に応じた段階的なアクション

## 予算消費による段階的対応

### 🔵 フェーズ0: 未達成期（0-最低消費量）
- **状態**: 最低消費量に未到達
- **問題**: 基本動作確認すら完了していない
- **対応**:
  - ログインノード実行の疑いを即座に調査
  - ジョブ投入方法の確認
  - 環境構築の問題を優先解決
  - PMの「そろそろ終わり」判断を防ぐため積極的に実行

### 🟢 フェーズ1: 積極的探索期（最低消費量-想定消費量の50%）
- **状態**: 基本動作確認完了、予算に余裕あり
- **戦略**: 
  - 新しい最適化手法を積極的に試行
  - 複数のパラメータを広範囲に探索
  - 並列度の高い実験を推奨

### 🟡 フェーズ2: 効率重視期（想定消費量の50%-80%）
- **状態**: 順調に進行中
- **戦略**:
  - 成果の出ている手法に集中
  - パラメータチューニングの収束を意識
  - コスト効率を重視

### 🟠 フェーズ3: 収束期（想定消費量の80%-100%）
- **状態**: 想定消費量に接近
- **戦略**:
  - 最も有望な最適化のみ継続
  - 新規実装を慎重に判断
  - 成果のまとめを開始

### 🔴 フェーズ4: 警戒期（想定消費量-デッドラインの90%）
- **状態**: デッドラインに接近中
- **アクション**:
  - 新規ジョブは事前承認制
  - 実行中ジョブの早期終了を検討
  - 最終レポート準備

### ⛔ フェーズ5: 強制終了（デッドラインの90%-100%）
- **状態**: 予算上限間近
- **アクション**:
  - 新規ジョブ完全禁止
  - 重要ジョブのみ完了待機
  - 5分以内に全作業終了

## 予算追跡方法

### budget_history.mdの記録形式
```markdown
## プロジェクト開始時
- UTC時刻: 2025-01-30T10:00:00Z
- 開始時used: 12,345 ポイント
- 最低消費量: 100 ポイント（従来500→緩和）
- 想定消費量: 1,000 ポイント
- デッドライン: 1,500 ポイント

## 最新確認時
- UTC時刻: 2025-01-30T12:00:00Z
- 現在のused: 12,845 ポイント
- **本プロジェクトでの使用量: 500 ポイント**
- 想定消費量に対する進捗: 50%
- デッドラインに対する消費率: 25%
- **現在フェーズ: 🟡 フェーズ2: 効率重視期**
```

### 監視コマンド（スパコン依存）
- 不老: `charge`
- その他: `_remote_info/command.md`参照
- **注意**: 各スパコンで予算確認コマンドは異なるため、必ず事前確認すること

### 予算効率メトリクス
```
効率スコア = (性能向上率) / (ポイント消費)

判定基準:
- 高効率: スコア > 0.1
- 標準: 0.01 < スコア < 0.1  
- 低効率: スコア < 0.01
```

## エージェント別の対応

### PM（予算管理の中心）
- **5-10分ごと**に予算状況を確認
- フェーズ移行時に全エージェントへ即座に通知
- 予算消費率と効率スコアに基づくリソース再配分
- 予算基準による客観的な終了決定（主観排除）

```bash
# 予算確認と通知の自動化（コマンドはスパコンにより異なる）
# 例: 不老の場合
current_usage=$(charge | grep "used" | awk '{print $2}')
consumption_rate=$((current_usage * 100 / budget_limit))

if [ $consumption_rate -ge 70 ] && [ $last_phase != "収束期" ]; then
    agent_send.sh ALL "[PM] 予算消費率70%到達。フェーズ3:収束期に移行。新規実装を停止してください。"
fi
```

### SE（予算効率の分析）
- 予算効率（ポイント/性能向上）を定期的に計算
- 非効率なPGの特定と改善提案
- 予算消費予測グラフの生成
- フェーズ移行の妥当性を検証

### PG（予算意識した実装）
- **ジョブ投入前に必ず予算フェーズを確認**
- フェーズ3以降は新規実装禁止
- フェーズ4では既存ジョブの結果確認のみ
- 長時間ジョブは事前にPMへ相談

```bash
# PGのジョブ投入前チェック
if [ $current_phase -ge 4 ]; then
    echo "[ERROR] フェーズ4以降は新規ジョブ投入禁止"
    agent_send.sh PM "[PG] 新規ジョブ投入を試みましたが、フェーズ4のため中止しました"
    exit 1
fi
```

### CD（成果物保全）
- 予算状況に関わらずSOTAコードの即座のバックアップ
- フェーズ4到達時点で最終GitHub同期

## 予算枯渇時の緊急手順

1. **即座に実行**
   - 全実行中ジョブの`scancel`/`qdel`
   - SSH/SFTPセッションの終了
   - 最新SOTAコードのGitHub push

2. **5分以内に完了**
   - 各エージェントの最終ChangeLog.md更新
   - final_report.mdの生成
   - 成果物の整理

3. **クリーンアップ**
   - スパコン側の大容量ファイル削除（任意）
   - ローカル一時ファイルの削除

## 予算閾値と消費率の計算

### 3段階の予算閾値
PMがrequirement_definition.mdで設定する3つの閾値：
1. **最低消費量**: 基本動作確認に必要な最小限のポイント
2. **想定消費量**: 通常の最適化作業で期待されるポイント
3. **デッドライン**: プロジェクトの絶対上限

### 消費率の計算方法
```
本プロジェクトの使用量 = 現在のused値 - 開始時のused値
消費率 = (本プロジェクトの使用量 / デッドライン) × 100
```

**重要**: 
- usedは**ユーザの年間累積値**であり、本プロジェクトだけの値ではない
- 必ず開始時のused値との差分で計算すること
- budget_history.mdに差分が記録されているので、それを参照

### フェーズ判定の実装責任
- **PMの責務**: budget_history.mdを5-10分ごとに更新し、消費率を計算
- **各エージェント**: budget_history.mdから現在のフェーズを読み取る
- スパコン固有の予算確認コマンドは`_remote_info/command.md`に記載

## 重要な注意事項
- **ログインノード実行は厳禁**: 予算消費しないが規約違反
- **ポイント未消費の警告**: ジョブ実行後も消費がない場合、即座に警告
- **予算情報の扱い**: 個人情報のため、具体的な残額は記載しない（used値と差分のみ）
- **主観的判断の完全排除**: PMの「そろそろ」という判断は一切行わない